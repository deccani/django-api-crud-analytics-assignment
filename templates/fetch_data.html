{% extends "base.html" %}
{% block content %}

<h3 class="mb-4">External API Integration – Fetch World Bank Economic Indicators</h3>

<div class="mb-3">
    <label class="mb-2"> Select Type to Fetch Data</label>
    <select id="indicatorSelect" class="form-control">
        <option value="NY.GDP.MKTP.CD">GDP (Current US$)</option>
        <option value="SP.POP.TOTL">Total Population</option>
        <option value="SL.UEM.TOTL.NE.ZS">Unemployment %</option>
    </select>
</div>

<button class="btn btn-primary" onclick="runFetch()">
    <i class="fas fa-download"></i> Fetch Data
</button>

<p id="result" class="mt-3 text-success"></p>

<div id="loader" style="display:none; text-align:center;">
    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
    <p class="mt-2">Fetching data, please wait...</p>
</div>

<div id="fetchedList" style="display:none;">
    <h5>Fetched Records:</h5>
    <ul id="dataList"></ul>
</div>
<h5 id="tableTitle" style="display:none;" class="mt-4"></h5>

<table class="table table-bordered mt-3" id="dataTable" style="display:none;">
    <thead class="table-dark">
        <tr>
            <th>Country</th>
            <th>Year</th>
            <th>Value</th>
        </tr>
    </thead>
    <tbody id="dataBody"></tbody>
</table>

<script>
    const indicatorNames = {
        "NY.GDP.MKTP.CD": "GDP (In Current US$)",
        "SP.POP.TOTL": "Total Population",
        "SL.UEM.TOTL.NE.ZS": "Unemployment %"
    };

    function runFetch() {
        document.getElementById("loader").style.display = "block";
        document.getElementById("dataTable").style.display = "none";
        document.getElementById("tableTitle").style.display = "none";
        document.getElementById("dataBody").innerHTML = "";

        const indicatorCode = document.getElementById("indicatorSelect").value;

        fetch("/api/tasks/fetch-indicator/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                indicator: document.getElementById("indicatorSelect").value,
                countries: ["IN", "US", "CN"],
                start_year: 2000,
                end_year: 2025
            })
        })
            .then(res => res.json())
            .then(data => {
                document.getElementById("loader").style.display = "none";

                const table = document.getElementById("dataTable");
                const tbody = document.getElementById("dataBody");
                tbody.innerHTML = "";

                document.getElementById("tableTitle").style.display = "block";
                document.getElementById("tableTitle").innerHTML =
                    `Fetched Data for: India, USA, China – ${indicatorNames[indicatorCode]}`;


                data.data.forEach(item => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
            <td>${item.country}</td>
            <td>${item.year}</td>
            <td>${item.value ?? "N/A"}</td>`;
                    tbody.appendChild(row);
                });

                table.style.display = "table";
            });
    }

</script>
{% endblock %}