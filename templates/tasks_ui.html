{% extends "base.html" %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<h3 class="mb-4">Task Manager (CRUD + REST API)</h3>

<button class="btn btn-primary mb-3" onclick="openCreateModal()">
    <i class="fas fa-plus"></i> Create Task
</button>

<table class="table table-bordered">
    <thead class="table-dark">
        <tr>
            <th></th>
            <th>Title</th>
            <th>Description</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="taskTableBody">
    </tbody>
</table>

<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="modalTitle" class="modal-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="taskId">

                <label>Title:</label>
                <input id="title" class="form-control mb-2">

                <label>Description:</label>
                <textarea id="description" class="form-control mb-2"></textarea>

                <label>Status:</label>
                <select id="status" class="form-control">
                    <option value="pending">Pending</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveTask()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this task?
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-trash-alt"></i> Delete
                </button>
            </div>

        </div>
    </div>
</div>

<script>
    let deleteTaskId = null;

    function loadTasks() {
        fetch("/api/tasks/list/")
            .then(response => response.json())
            .then(data => {
                const body = document.getElementById("taskTableBody");
                body.innerHTML = "";

                if (data.length === 0) {
                    body.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">No records found</td>
                    </tr>
                `;
                    return;
                }

                data.forEach((task, index) => {
                    body.innerHTML += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${task.title}</td>
                    <td>${task.description}</td>
                    <td>${task.status}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="openEditModal(${task.id}, '${task.title}', '${task.description}', '${task.status}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                       <button class="btn btn-danger btn-sm" onclick="openDeleteModal(${task.id})">
    <i class="fas fa-trash-alt"></i> Delete
</button>
                    </td>
                </tr>`;
                })
            })
    }

    function openCreateModal() {
        document.getElementById("modalTitle").innerText = "Create Task";
        document.getElementById("taskId").value = "";
        document.getElementById("title").value = "";
        document.getElementById("description").value = "";
        document.getElementById("status").value = "pending";

        new bootstrap.Modal(document.getElementById("taskModal")).show();
    }

    function openEditModal(id, title, description, status) {
        document.getElementById("modalTitle").innerText = "Edit Task";
        document.getElementById("taskId").value = id;
        document.getElementById("title").value = title;
        document.getElementById("description").value = description;
        document.getElementById("status").value = status;

        new bootstrap.Modal(document.getElementById("taskModal")).show();
    }

    function saveTask() {
        const id = document.getElementById("taskId").value;
        const payload = {
            title: document.getElementById("title").value,
            description: document.getElementById("description").value,
            status: document.getElementById("status").value
        };

        const method = id ? "PUT" : "POST";
        const url = id ? `/api/tasks/update/${id}/` : `/api/tasks/create/`;

        fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        }).then(() => {
            loadTasks();
            bootstrap.Modal.getInstance(document.getElementById("taskModal")).hide();
        });
    }

    function openDeleteModal(id) {
        deleteTaskId = id;
        new bootstrap.Modal(document.getElementById("deleteModal")).show();
    }

    function confirmDelete() {
        fetch(`/api/tasks/delete/${deleteTaskId}/`, { method: "DELETE" })
            .then(() => {
                loadTasks();
                bootstrap.Modal.getInstance(document.getElementById("deleteModal")).hide();
            });
    }

    loadTasks();
</script>
{% endblock %}